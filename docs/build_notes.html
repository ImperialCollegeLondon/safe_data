<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Building and releasing safedata â€¢ safedata</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script>




<meta property="og:title" content="Building and releasing safedata" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body>
    <div class="container template-title-body">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">safedata</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.5.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="articles/overview.html">An overview of data at the SAFE Project</a>
    </li>
    <li>
      <a href="articles/using_safe_data.html">Using the `safedata` package</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="contents col-md-9">
    <div class="page-header">
      <h1>Building and releasing safedata</h1>
    </div>

<div id="building-and-releasing-safedata" class="section level1">

<p>This repository and package uses a number of systems that you need to be aware of if you plan to work with the codebase:</p>
<ul>
<li>The repository has (now) been set up to use the git flow system for controlling development and releases across branches.</li>
<li>Documentation for the package is maintained using <code>roxygen</code> and <code>pkgdown</code>.</li>
<li>The repository uses the Travis continuous integration (CI) system.</li>
</ul>
<p>These notes provide a brief walk through for these systems and some package specific requirements for releases. Note that the <code>build_scripts</code> folder in the repository contains three scripts containing the code blocks used in some of the steps described below. All are set up to be run from directly inside the <code>build_scripts</code> directory.</p>
<div id="documentation" class="section level2">
<h2 class="hasAnchor">
<a href="#documentation" class="anchor"></a>Documentation</h2>
<p>The <code>roxygen</code> package , all of the package documentation is located in one of three places:</p>
<ol>
<li>Markup inside the <code>R</code> source files - there are blocks of comments starting with <code>#'</code> that contain all of the documentation that goes into the normal R documentaion (<code>.Rd</code>) files.</li>
<li>Vignettes, formatted as <code>Rmarkdown</code> files in the <code>vignettes</code> directory.</li>
<li>The <code>README.md</code> document.</li>
</ol>
<p>When the documentation has been changed then the <code>.Rd</code> files in <code>man</code> and any vignettes can be built automatically. The key command is:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="ex">Rscript</span> -e <span class="st">"devtools::document()"</span></span></code></pre></div>
<p>In addition to using <code>roxygen</code> to maintain the in-package documentation, <code>safedata</code> also uses <code>pkgdown</code> to create a documentation website. This needs one additional file - <code>_pkgdown.yml</code> - that is used to structure the website. This file typically only needs updating when new functions are added, as they need to be added into the reference structure.</p>
<p>Rebuilding the website uses two commands:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="ex">Rscript</span> -e <span class="st">" pkgdown::clean_site()"</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="ex">Rscript</span> -e <span class="st">" pkgdown::build_site()"</span></span></code></pre></div>
<p>This removes old files and recreates the website in the <code>docs</code> directory. This directory is then automatically used by GitHub Pages to create the package website at:</p>
<p><a href="https://imperialcollegelondon.github.io/safedata/" class="uri">https://imperialcollegelondon.github.io/safedata/</a></p>
</div>
<div id="repo-branches-and-git-flow" class="section level2">
<h2 class="hasAnchor">
<a href="#repo-branches-and-git-flow" class="anchor"></a>Repo branches and <code>git flow</code>
</h2>
<p>Day to day development happens on the <code>develop</code> branch, although you can also create specific <code>feature</code> branches for new features. When you have code that you want to release as a new version then <code>git flow</code> is used to create a <code>release</code> branch that is used to check and make final changes. That <code>release</code> branch is then merged into <code>master</code> and tagged as the new release, and also back into <code>develop</code> to bring back last minute fixes.</p>
<p>The <code>master</code> branch should really only ever see merges in from a <code>release</code> branch - you should not work on it directly.</p>
</div>
<div id="travis-ci" class="section level2">
<h2 class="hasAnchor">
<a href="#travis-ci" class="anchor"></a>Travis CI</h2>
<p>When commits are pushed to the Github origin then the package is automatically built and checked by Travis:</p>
<p><a href="https://travis-ci.org/github/ImperialCollegeLondon/safedata" class="uri">https://travis-ci.org/github/ImperialCollegeLondon/safedata</a></p>
<p>This happens on all branches, so day to day commits to <code>develop</code> will be built as well as commits to <code>release</code> branches and the creation of new tagged versions on <code>master</code>.</p>
<p>If you have made changes that you do not want to be built and checked then you can include <code>[ci skip]</code>, but the idea is that all changes should be checked so this is typically only used for documentation changes and the like.</p>
</div>
<div id="release-cycle" class="section level2">
<h2 class="hasAnchor">
<a href="#release-cycle" class="anchor"></a>Release cycle</h2>
<p>These are the steps needed to release a new version of <code>safedata</code>.</p>
<div id="configure-git" class="section level3">
<h3 class="hasAnchor">
<a href="#configure-git" class="anchor"></a>Configure <code>git</code>
</h3>
<p>It is easier if <code>git</code> is configured to push new tags along with commits. This essentially just means that new releases can be sent with a single commit, which is simpler and saves Travis from building both the the code commit and then the tagged version. This only needs to be set once.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">set</span> <span class="fu">git</span> config --global push.followTags true</span></code></pre></div>
</div>
<div id="update-the-example-directory" class="section level3">
<h3 class="hasAnchor">
<a href="#update-the-example-directory" class="anchor"></a>Update the example directory</h3>
<p>The <code>safedata</code> package ships with a zipped <code>safedata</code> directory that is used in the code examples. The search functionality in <code>safedata</code> uses the live database via the API so, unless you update this example directory, running the search examples may return Zenodo record IDs that are missing from the example directory. This will create checking errors.</p>
<p>The R code below replaces this file with a fresh zipped example directory.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode refresh_example_dir.r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(safedata)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span>(<span class="st">'../inst/safedata_example_dir/'</span>)</span>
<span id="cb4-3"><a href="#cb4-3"></a>path &lt;-<span class="st"> "safedata_example_dir"</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co"># create the new directory and add the example file</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="kw"><a href="reference/set_safe_dir.html">set_safe_dir</a></span>(path, <span class="dt">create=</span><span class="ot">TRUE</span>)</span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="kw"><a href="reference/download_safe_files.html">download_safe_files</a></span>(<span class="dv">1400562</span>, <span class="dt">confirm=</span><span class="ot">FALSE</span>)</span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co"># remove the old archive</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="kw"><a href="https://rdrr.io/r/base/files.html">file.remove</a></span>(<span class="st">'safedata_example_dir.zip'</span>)</span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co"># create the new one from the updated directory</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="kw"><a href="https://rdrr.io/r/utils/zip.html">zip</a></span>(<span class="st">'safedata_example_dir.zip'</span>, path)</span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="co"># remove the directory, leaving just the refreshed archive</span></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="kw"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span>(path, <span class="dt">recursive=</span><span class="ot">TRUE</span>)</span></code></pre></div>
<p>If course, if someone publishes a new dataset before the release occurs, you may still get an error and have to repeat this step!</p>
</div>
<div id="check-the-develop-code" class="section level3">
<h3 class="hasAnchor">
<a href="#check-the-develop-code" class="anchor"></a>Check the <code>develop</code> code.</h3>
<p>Releases start from the <code>develop</code> branch, with a bunch of commits that you want to release as a new version. Before you do anything, you should check that the current commit in <code>develop</code> is building correctly on Travis.</p>
<p>In practice, you have probably just finished tweaking a code file, so you might as well run through the full checking process locally.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode build_and_check.sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># a) Move into the source directory and update the documents</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co">#    using Roxygen and pkgdown</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="bu">cd</span> safedata</span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="ex">Rscript</span> -e <span class="st">"devtools::document()"</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="ex">Rscript</span> -e <span class="st">" pkgdown::clean_site()"</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="ex">Rscript</span> -e <span class="st">" pkgdown::build_site()"</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="bu">cd</span> ../</span>
<span id="cb5-8"><a href="#cb5-8"></a></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co"># b) Build the package from the source directory</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="ex">R</span> CMD BUILD safedata</span>
<span id="cb5-11"><a href="#cb5-11"></a></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="co"># c) Identify the version name that just got built from the </span></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="co">#    package DESCRIPTION file and then check it for CRAN</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="va">VERSION=$(</span><span class="fu">sed</span> -n -e <span class="st">'4p'</span> safedata/DESCRIPTION  <span class="kw"><a href="https://rdrr.io/r/base/Logic.html">|</a></span> <span class="fu">cut</span> -d <span class="st">" "</span>  -f 2<span class="va">)</span></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="ex">R</span> CMD CHECK --as-cran --run-donttest safedata_<span class="va">$VERSION</span>.tar.gz </span></code></pre></div>
<p>Look at the output of <code>R CMD CHECK</code> and resolve any issues before moving on. Do not worry about a note saying <code>Version contains large components</code> - that is about to be fixed.</p>
</div>
<div id="create-the-new-release-branch" class="section level3">
<h3 class="hasAnchor">
<a href="#create-the-new-release-branch" class="anchor"></a>Create the new release branch</h3>
<p>The following creates a new candidate branch containing the current <code>develop</code> code. You need to specify the upcoming release version number, so for example to release version <code>1.0.6</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">git</span> flow release start 1.0.6</span></code></pre></div>
<p>This will create the <code>release/1.0.6</code> branch and check it out.</p>
<p>You should now immediately update the <code>DESCRIPTION</code> file to match that version number. In this example, that should mean changing the previous development version number (<code>-9000</code> is used to indicate code in development between versions ):</p>
<pre><code>Version: 1.0.5-9000</code></pre>
<p>to</p>
<pre><code>Version: 1.0.6</code></pre>
<p>When you commit that change, the Travis CI process will start for the <code>release</code> branch. Travis is configured (see <code>.travis.yml</code>) to build the package under R stable on Ubuntu and Mac and R devel on Ubuntu.</p>
</div>
<div id="submit-to-win-builder" class="section level3">
<h3 class="hasAnchor">
<a href="#submit-to-win-builder" class="anchor"></a>Submit to <code>win-builder</code>
</h3>
<p>Travis CI does not currently check packages under Windows, but the R Project maintains a Windows test environment that can be used instead. You should build the package on the <code>release</code> branch. If everything checked out ok before creating the release, this is just updating the version name.</p>
<p>You then need to upload that file to <code>win-builder</code>. The python script <code>upload_to_win-builder.py</code> in <code>build_scripts</code> will do this for you - it is simply automating the process of using FTP to upload the current version for checking under both R stable and R devel. Note that <code>win-builder</code> communicate by email with the package maintainer (whoever has the <code>cre</code> flag in the <code>authors</code> section of the <code>DESCRIPTION</code> file.</p>
</div>
<div id="wait" class="section level3">
<h3 class="hasAnchor">
<a href="#wait" class="anchor"></a>Wait.</h3>
<p>Ideally what happens now is that the build and check process on Travis CI and <code>win-builder</code> all pass. You must wait for these checks to complete.</p>
<p>Obviously, if any errors or warnings crop up in the checking process, those should be fixed in the <code>release</code> branch. The changes should be committed and pushed to start a new round of Travis CI checking and you will need to rebuild and resubmit to <code>win-builder</code></p>
</div>
<div id="finish-the-release" class="section level3">
<h3 class="hasAnchor">
<a href="#finish-the-release" class="anchor"></a>Finish the release</h3>
<p>Once the <code>release</code> branch is passing checks on all platforms, then the candidate release is ready to be released as a version. Using <code>1.0.6</code> as the example version number again, the command is: .</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">git</span> flow release finish 1.0.6</span></code></pre></div>
<p>You will be asked for some commit messages and a new tag comment, which will simply be the version number. You should then be on the <code>master</code> branch in a fresh commit tagged with the version number. You can now push this to create the release - if youâ€™ve set the config described above then a single push will create the commit and tag.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a><span class="fu">git</span> push</span></code></pre></div>
<p>You should now <em>immediately</em> get off the <code>master</code> branch, before you accidentally change the files or commit to it, and update the version number in <code>DESCRIPTION</code> to indicate that changes are now in the development version of the new release. This is a trivial change, so we can use <code>[ci skip]</code> to avoid triggering a Travis build.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">git</span> checkout develop</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="co"># Edit DESCRIPTION to e.g. version 1.0.6-9000</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="fu">git</span> commit -m <span class="st">"Bump develop version [ci skip]"</span> DESCRIPTION</span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="fu">git</span> push</span></code></pre></div>
</div>
<div id="release-to-cran" class="section level3">
<h3 class="hasAnchor">
<a href="#release-to-cran" class="anchor"></a>Release to CRAN</h3>
<p>You should now use the outputs from Travis CI and <code>win-builder</code> to update the file <code>cran-comments.md</code> and the contents of that should be copied into in the comments section of the submission form. The CRAN maintainers expect submitted packages to be functional and fully checked and these notes will help them see that the package has been properly checked.</p>
<p>You can then submit the built package at: <a href="https://cran.r-project.org/submit.html" class="uri">https://cran.r-project.org/submit.html</a></p>
</div>
</div>
</div>

  </div>

</div>



      <footer>
      <div class="copyright">
  <p>Developed by Andy Aldersley, David Orme.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


