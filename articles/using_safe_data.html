<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using the `safedata` package • safedata</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using the `safedata` package">
<meta property="og:description" content="safedata">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">safedata</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/overview.html">An overview of data at the SAFE Project</a>
    </li>
    <li>
      <a href="../articles/using_safe_data.html">Using the `safedata` package</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ImperialCollegeLondon/safedata/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using the <code>safedata</code> package</h1>
                        <h4 class="author">Andy Aldersley and David Orme</h4>
            
            <h4 class="date">2020-07-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ImperialCollegeLondon/safedata/blob/master/vignettes/using_safe_data.Rmd"><code>vignettes/using_safe_data.Rmd</code></a></small>
      <div class="hidden name"><code>using_safe_data.Rmd</code></div>

    </div>

    
    
<p>The <code>safedata</code> package makes it easy to search for and use datasets collected at the SAFE Project. It provides an interface to download data files and packaged record metadata and then functions to load data worksheets and add taxonomic and spatial data where available.</p>
<p>For further information on the publication and structure of data through the SAFE Project and within the <code>safedata</code> package, see the Overview vignette: <code>vignette("overview", package = "safedata")</code>.</p>
<div id="installing-safedata" class="section level1">
<h1 class="hasAnchor">
<a href="#installing-safedata" class="anchor"></a>Installing <code>safedata</code>
</h1>
<p>The <code>safedata</code> package is available from CRAN:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"safedata"</span>)</pre></body></html></div>
<p>The development version can also be installed from GitHub:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="kw pkg">devtools</span><span class="kw ns">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span>(<span class="st">"ImperialCollegeLondon/safedata"</span>)</pre></body></html></div>
<div id="package-dependencies" class="section level2">
<h2 class="hasAnchor">
<a href="#package-dependencies" class="anchor"></a>Package dependencies</h2>
<p>The <code>safedata</code> package requires the following packages:</p>
<ul>
<li>
<code>readxl</code>, to read data directly from Excel datasets,</li>
<li>
<code>jsonlite</code> and <code>curl</code>, to communicate with the SAFE API and to read downloaded JSON data,</li>
<li>
<code>chron</code>, to represent time of day data, and</li>
<li>
<code>sf</code>, to handle spatial data about sampling locations.</li>
</ul>
</div>
</div>
<div id="the-safe-data-directory" class="section level1">
<h1 class="hasAnchor">
<a href="#the-safe-data-directory" class="anchor"></a>The SAFE data directory</h1>
<p>The <code>safedata</code> package makes use of a local directory to store downloaded data, index and metadata files (<code>vignette("overview", package = "safedata")</code> for details) . These files are needed for the <code>safedata</code> functions to work correctly, so the first step in using <code>safedata</code> is to set the location of the directory and the package will remind you to do this when it is loaded.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">safedata</span>)
<span class="co">## SAFE package reminder: Please set SAFE data directory using set_safe_dir()</span></pre></body></html></div>
<div id="initialising-a-safe-data-directory" class="section level2">
<h2 class="hasAnchor">
<a href="#initialising-a-safe-data-directory" class="anchor"></a>Initialising a SAFE data directory</h2>
<p>If this is the first time you are loading <code>safedata</code> – or if you simply want to have two separate SAFE data directories – then you need to create a new, empty directory.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/safedata/man/set_safe_dir.html">set_safe_dir</a></span>(<span class="st">'my_safe_directory'</span>, <span class="kw">create</span><span class="kw">=</span><span class="fl">TRUE</span>)
<span class="co">## Safe data directory created</span></pre></body></html></div>
<p>This will create the directory and download the current index files. You cannot use an existing directory: the package wants to start with a fresh, empty directory. Note that the directory path is stored in <code><a href="https://rdrr.io/r/base/options.html">options()</a></code>:</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/options.html">getOption</a></span>(<span class="st">'safedata.dir'</span>)
<span class="co">## [1] "my_safe_directory"</span></pre></body></html></div>
</div>
<div id="using-an-existing-safe-data-directory" class="section level2">
<h2 class="hasAnchor">
<a href="#using-an-existing-safe-data-directory" class="anchor"></a>Using an existing SAFE data directory</h2>
<p>Once you have a SAFE data directory, the same function is used to tell the <code>safedata</code> package where to look for index and data files:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/safedata/man/set_safe_dir.html">set_safe_dir</a></span>(<span class="st">'my_safe_directory'</span>)
<span class="co">## Checking for updates</span>
<span class="co">##  - Index up to date</span>
<span class="co">##  - Gazetteer up to date</span>
<span class="co">##  - Location aliases up to date</span>
<span class="co">## Validating directory</span></pre></body></html></div>
<p>You will see that this function checks with the SAFE Project website for updates to the key index files. This can be turned off for offline use (<code><a href="https://rdrr.io/pkg/safedata/man/set_safe_dir.html">set_safe_dir('~/my_safe_directory', update=FALSE)</a></code>). The function also validates local data files: it checks the MD5 hash of local data file copies against the MD5 of the published file.</p>
<p>The rest of this vignette uses an example SAFE data directory that is included within the package. This is set up for use using the following command but note that this is a temporary data folder and is only used for demonstration purposes.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/safedata/man/set_example_safe_dir.html">set_example_safe_dir</a></span>()</pre></body></html></div>
<pre><code>## Validating directory</code></pre>
</div>
</div>
<div id="finding-data" class="section level1">
<h1 class="hasAnchor">
<a href="#finding-data" class="anchor"></a>Finding data</h1>
<p>You can browse datasets published by the SAFE Project at either:</p>
<ul>
<li>our <a href="https://zenodo.org/communities/safe">SAFE Zenodo community</a> or</li>
<li>the <a href="https://www.safeproject.net/datasets/view_datasets">SAFE Project website</a>.</li>
</ul>
<p>If you have done this, or have a dataset DOI from another source, then you can look up the dataset directly.</p>
<p>However, if you want to search the dataset metadata or the taxa and locations covered by datasets then there are a set of search functions built into the <code>safedata</code> package.</p>
<div id="search-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#search-functions" class="anchor"></a>Search functions</h2>
<p>The <code>safedata</code> package contains a set of search functions to explore datasets. These functions make use of a metadata index stored on the SAFE Project website and so need an internet connection to work. These search functions provide structured access to the same metadata shown in project description text but also provide extended taxonomic and spatial searches.</p>
<p>The functions are:</p>
<ul>
<li>
<code><a href="https://rdrr.io/pkg/safedata/man/search_safe.html">search_text()</a></code>: free text search of dataset and worksheet titles and descriptions.</li>
<li>
<code><a href="https://rdrr.io/pkg/safedata/man/search_safe.html">search_fields()</a></code>: searches worksheet field names and descriptions and field types.</li>
<li>
<code><a href="https://rdrr.io/pkg/safedata/man/search_safe.html">search_authors()</a></code>: searches dataset authors</li>
<li>
<code><a href="https://rdrr.io/pkg/safedata/man/search_safe.html">search_dates()</a></code>: searches for overlap with the start and end date of a dataset.</li>
<li>
<code><a href="https://rdrr.io/pkg/safedata/man/search_safe.html">search_taxa()</a></code>: searches for datasets containing particular taxa.</li>
<li>
<code><a href="https://rdrr.io/pkg/safedata/man/search_safe.html">search_spatial()</a></code>: searches for datasets sampling at or near a particular location.</li>
</ul>
<p>All of these functions return a <code>safe_record_set</code> objects, which is just a data frame containing validated record ids and access information and so you can use the normal data frame indices (e.g. <code>recs[1,]</code>) to select particular records.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">soil_datasets</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/safedata/man/search_safe.html">search_text</a></span>(<span class="st">'soil'</span>)</pre></body></html></div>
<pre><code>## Search returned 19 records</code></pre>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">soil_datasets</span>)</pre></body></html></div>
<pre><code>## Set includes 14 concept ids and 19 record ids: 
##  - 10 open and most recent (*)
##  - 5 open and outdated (o)
##  - 4 under embargo or restricted (x)
## 
##    concept  record available
## 1  1198564 3857210         *
## 2  3247591 3247592         *
## 3  3251886 3258079         *
## 4  ------- 3251887         o
## 5  3251899 3258117         *
## 6  ------- 3251900         o
## 7  3251901 3897394         *
## 8  ------- 3614876         o
## 9  ------- 3258082         o
## 10 ------- 3251902         o
## 11 3265745 3265746         *
## 12 3266770 3266771         x
## 13 3266821 3266822         *
## 14 3354067 3354068         *
## 15 3402745 3402746         x
## 16 3698114 3698115         x
## 17 3888374 3888375         *
## 18 3897376 3897377         x
## 19 3929631 3929632         *</code></pre>
<div id="taxon-search-details" class="section level3">
<h3 class="hasAnchor">
<a href="#taxon-search-details" class="anchor"></a>Taxon search details</h3>
<p>Published datasets contain a taxonomic index of any organisms referred to within the data - see <a href="https://safedata-validator.readthedocs.io/en/latest/data_format/taxa/">here</a> for details of the Taxa worksheet containing the index.</p>
<p>The taxa in this index, along with all of the parent taxa in the taxonomic hierarchy leading up to that those taxa, are added to a taxonomic database on the SAFE Project website. The <code><a href="https://rdrr.io/pkg/safedata/man/search_safe.html">search_taxa()</a></code> function searches that index to identify all the datasets that contain a particular taxon.</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">ants</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/safedata/man/search_safe.html">search_taxa</a></span>(<span class="st">'Formicidae'</span>))
<span class="co">## Search returned 11 records</span>
<span class="co">## Set includes 10 concept ids and 11 record ids: </span>
<span class="co">##  - 8 open and most recent (*)</span>
<span class="co">##  - 1 open and outdated (o)</span>
<span class="co">##  - 2 under embargo or restricted (x)</span>
<span class="co">## </span>
<span class="co">##    concept  record available</span>
<span class="co">## 1  1198301 1198302         *</span>
<span class="co">## 2  1198471 1237732         *</span>
<span class="co">## 3  1198838 1198839         *</span>
<span class="co">## 4  1237729 1237730         x</span>
<span class="co">## 5  1400561 1400562         *</span>
<span class="co">## 6  1995247 1995439         *</span>
<span class="co">## 7  2537072 3901735         x</span>
<span class="co">## 8  3247484 3876227         *</span>
<span class="co">## 9  ------- 3247485         o</span>
<span class="co">## 10 3265745 3265746         *</span>
<span class="co">## 11 3354067 3354068         *</span></pre></body></html></div>
<p>The taxonomic index is built around the GBIF backbone taxonomic database and include the following core taxonomic levels: kingdom, phylum, class, order, family, genus, species and subspecies. It is also possible to search by <a href="https://www.gbif.org/species/4342">GBIF ID</a>.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">ants</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/safedata/man/search_safe.html">search_taxa</a></span>(<span class="kw">gbif_id</span><span class="kw">=</span><span class="fl">4342</span>)
<span class="co">## Search returned 11 records</span></pre></body></html></div>
</div>
<div id="spatial-search-details" class="section level3">
<h3 class="hasAnchor">
<a href="#spatial-search-details" class="anchor"></a>Spatial search details</h3>
<p>Datasets also have to provide a full index of sampling locations used in the data. Sampling locations are either linked to existing sampling locations included in the <a href="https://www.safeproject.net/info/gazetteer">SAFE gazetteer</a> or users can identify new sampling locations and provide location data if possible.</p>
<p>The <code><a href="https://rdrr.io/pkg/safedata/man/search_safe.html">search_spatial()</a></code> function allows users to search for datasets by sampling locations. Accepted location names from the gazetteer can be used to search for datasets but users can also provide their own search geometries using the Well Known Text format. The search includes simple GIS capabilities to look for sampling within a given distance of the query location.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="co"># Datasets that include sampling within experimental block A</span>
<span class="no">within_a</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/safedata/man/search_safe.html">search_spatial</a></span>(<span class="kw">location</span><span class="kw">=</span><span class="st">'BL_A'</span>)
<span class="co">## Search returned 30 records</span>
<span class="co"># Datasets that sampled within 2 km of the Maliau Basin Field Study Centre</span>
<span class="no">near_maliau</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/safedata/man/search_safe.html">search_spatial</a></span>(<span class="kw">wkt</span><span class="kw">=</span><span class="st">'POINT(116.97394 4.73481)'</span>, <span class="kw">distance</span><span class="kw">=</span><span class="fl">2000</span>)
<span class="co">## Search returned 56 records</span></pre></body></html></div>
<p>Note that WKT coordinates should be supplied as WGS84 longitude and latitude - typically the output of GPS receivers - but the database uses the local UTM 50N projected coordinate system for all distance calculations and GIS operations.</p>
</div>
</div>
<div id="look-up-a-specific-dataset" class="section level2">
<h2 class="hasAnchor">
<a href="#look-up-a-specific-dataset" class="anchor"></a>Look up a specific dataset</h2>
<p>Datasets are identified by their record number, which is the number included in both the dataset DOI and Zenodo URL. All of the following point to the same dataset:</p>
<ul>
<li><a href="https://doi.org/10.5281/zenodo.3247631" class="uri">https://doi.org/10.5281/zenodo.3247631</a></li>
<li><a href="https://doi.org/10.5281/zenodo.3247631">10.5281/zenodo.3247631</a></li>
<li>
<a href="https://zenodo.org/record/3247631">https://zenodo.org/record/3266821</a>)</li>
</ul>
<p>Note that all metadata is <em>available for all records</em>, regardless of whether they are open, embargoed or restricted. This includes field descriptions and taxon and location sampling so that users can assess whether a dataset is going to be useful even if it is not yet openly available.</p>
<p>Once you have the details of a dataset you are interestested in then you can validate a dataset reference to access metadata and available data, using the <code><a href="https://rdrr.io/pkg/safedata/man/validate_record_ids.html">validate_record_ids()</a></code> function. This function does the following:</p>
<ol style="list-style-type: decimal">
<li>checks that the record is valid,</li>
<li>checks whether the record number is a <strong>record id</strong>, referring to a specific version of a dataset, or a <strong>concept id</strong>, which identifies all the versions of a dataset. In the example code below, two of the values are record ids, so the appropriate concept id is located and printed, and one is a concept id, so no specific version number is given.</li>
<li>checks whether the data are currently available, and</li>
<li>provides an interface to download and import the related data files.</li>
</ol>
<p>Like the <code>search</code> functions, the output is <code>safe_record_set</code> object. Note that you can validate multiple references at once.</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">recs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/safedata/man/validate_record_ids.html">validate_record_ids</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'https://doi.org/10.5281/zenodo.3247631'</span>,
                              <span class="st">'10.5281/zenodo.3266827'</span>,
                              <span class="st">'https://zenodo.org/record/3266821'</span>))
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">recs</span>)</pre></body></html></div>
<pre><code>## Set includes 3 concept ids and 2 record ids: 
##  - 1 open and most recent (*)
##  - 0 open and outdated (o)
##  - 1 under embargo or restricted (x)
## 
##   concept  record available
## 1 3247630 3247631         x
## 2 3266821 -------          
## 3 3266826 3266827         *</code></pre>
<p>In addition, all of the main functions in <code>safedata</code> that expect to be passed a dataset id will run <code><a href="https://rdrr.io/pkg/safedata/man/validate_record_ids.html">validate_record_ids()</a></code> on their inputs, so you can simply use those URLs directly with those functions without needing to specifically create a <code>safe_record_set</code> yourself.</p>
</div>
</div>
<div id="displaying-dataset-metadata" class="section level1">
<h1 class="hasAnchor">
<a href="#displaying-dataset-metadata" class="anchor"></a>Displaying dataset metadata</h1>
<p>Printing a <code>safe_record_set</code> object displays a deliberately compact summary of a set of record ids. There are three function that show the detailed metadata for records at three levels:</p>
<ul>
<li>the <strong>concept</strong> level: metadata about all the published versions of a particualar dataset,</li>
<li>the <strong>record</strong> level: metadata about a specific version of a dataset, and</li>
<li>the <strong>worksheet</strong> level: metadata about the fields available in a particular data worksheet.</li>
</ul>
<div id="show_concepts" class="section level2">
<h2 class="hasAnchor">
<a href="#show_concepts" class="anchor"></a><code>show_concepts()</code>
</h2>
<p>The <code><a href="https://rdrr.io/pkg/safedata/man/show_concepts.html">show_concepts()</a></code> function displays concept level metadata about a set of record ids. This includes the (most recent) dataset title and a short summary of the versions available under the dataset concept. Note that the output is not restricted just to the set of record ids given to the function: it shows metadata for all versions for each of the concept ids included.</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/safedata/man/show_concepts.html">show_concepts</a></span>(<span class="no">recs</span>)</pre></body></html></div>
<pre><code>## 
## Concept ID: 3247630
## Title: Functional traits of tree species in old-growth and selectively logged forest
## Versions: 0 available, 1 embargoed or restricted
## 
##  record_id  published    embargo available
##    3247631 2019-06-17 2020-12-31         x
## 
## -------------
## 
## Concept ID: 3266821
## Title: Microclimate proxy measurements from a logging gradient in Malaysian Borneo (BALI project)
## Versions: 1 available, 0 embargoed or restricted
## 
##  record_id  published embargo available
##    3266822 2019-07-03      --         *
## 
## -------------
## 
## Concept ID: 3266826
## Title: Quantifying the spatial heterogeneity of forest conversion costs and how it relates to biodiversity, conservation and land use history
## Versions: 1 available, 0 embargoed or restricted
## 
##  record_id  published embargo available
##    3266827 2019-07-03      --         *</code></pre>
</div>
<div id="show_record" class="section level2">
<h2 class="hasAnchor">
<a href="#show_record" class="anchor"></a><code>show_record()</code>
</h2>
<p>This function shows metadata for a specific version of a dataset: if you give it a concept ID then it will display the available versions for that concept. Otherwise, the function prints out information about the dataset with that record id: it includes the dataset title, status and other dataset level metadata and then a summary of the data worksheets contained in the dataset.</p>
<p>Note that - because a <code>safe_record_set</code> is just a data frame with some extra information attached - you can use the usual data frame indexing to select a row to pass to other functions. Running <code><a href="https://rdrr.io/pkg/safedata/man/show_concepts.html">show_record()</a></code> also <em>requires an internet connection</em>: the package downloads a JSON file of the record metadata and stores it in the SAFE data directory.</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/safedata/man/show_concepts.html">show_record</a></span>(<span class="no">recs</span>[<span class="fl">3</span>,])</pre></body></html></div>
<pre><code>## Downloading 1 record metadata files</code></pre>
<pre><code>## 
## Record summary
## Title: Quantifying the spatial heterogeneity of forest conversion costs and how it relates to biodiversity, conservation and land use history
## Status: open
## External files: SAFE_COUPE.zip
## Locations: 187 locations reported
## 
## Data worksheets:
## name ncol nrow description
## Data   11  187 Dates of earliest and latest known salvage logging activity in logging coupes</code></pre>
</div>
<div id="show_worksheet" class="section level2">
<h2 class="hasAnchor">
<a href="#show_worksheet" class="anchor"></a><code>show_worksheet()</code>
</h2>
<p>This function shows metadata for a named worksheet within a specific record. The default is to show a compact table of field names, field types and truncated descriptions:</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/safedata/man/show_concepts.html">show_worksheet</a></span>(<span class="no">recs</span>[<span class="fl">3</span>,], <span class="st">'Data'</span>)</pre></body></html></div>
<pre><code>## Record ID: 3266827
## Worksheet name: Data
## Number of data rows: 187
## Number of data fields: 10
## Description:
## Dates of earliest and latest known salvage logging activity in logging coupes
## Status: open
## 
## Fields:
##    field_name           field_type
## 1  CoupeNumber          Location  
## 2  StartDateTrack       Date      
## 3  EndDateTrack         Date      
## 4  StartDateLocation    Date      
## 5  EndDateLocation      Date      
## 6  StartDateMeasurement Date      
## 7  EndDateMeasurement   Date      
## 8  Contractor           ID        
## 9  GlobalStart          Date      
## 10 GlobalEnd            Date      
##    description                                     
## 1  Coupe number                                    
## 2  Earliest date of logging activity recorded th...
## 3  Last date of logging activity recorded throug...
## 4  Earliest date of logging activity recorded th...
## 5  Last date of logging activity recorded throug...
## 6  Earliest date of logging activity recorded th...
## 7  Last date of logging activity recorded throug...
## 8  Name of the contractor responsible for the co...
## 9  Earliest date of any recorded salvage logging...
## 10 Last date of any recorded salvage logging act...</code></pre>
<p>There is also an extended display (<code>extended_fields=TRUE</code>) that will print out a list of all the available metadata for each field.</p>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/safedata/man/show_concepts.html">show_worksheet</a></span>(<span class="no">recs</span>[<span class="fl">3</span>,], <span class="st">'Data'</span>, <span class="kw">extended_fields</span><span class="kw">=</span><span class="fl">TRUE</span>)</pre></body></html></div>
<pre><code>## Record ID: 3266827
## Worksheet name: Data
## Number of data rows: 187
## Number of data fields: 10
## Description:
## Dates of earliest and latest known salvage logging activity in logging coupes
## Status: open
## 
## Fields:
## CoupeNumber :
##  - field_type: Location
##  - description: Coupe number
## StartDateTrack :
##  - field_type: Date
##  - description: Earliest date of logging activity recorded through GPS loggers on bulldozers
...</code></pre>
</div>
</div>
<div id="downloading-data" class="section level1">
<h1 class="hasAnchor">
<a href="#downloading-data" class="anchor"></a>Downloading data</h1>
<p>Once you have found records for which you want to explore the actual data, then you first need to download the data files for the dataset from Zenodo. This uses the <code><a href="https://rdrr.io/pkg/safedata/man/download_safe_files.html">download_safe_files()</a></code> function and you can either give that a URL or number for a dataset or pass it an existing <code>safe_record_set</code>. The function will check which datasets are currently available and download them to the SAFE data directory. The default behaviour is to present a brief report on the number and size of available files to be downloaded before actually doing anything:</p>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/safedata/man/download_safe_files.html">download_safe_files</a></span>(<span class="no">within_a</span>)
<span class="co">## 26 files requested from 26 records</span>
<span class="co">##  - 0 local (0 bytes)</span>
<span class="co">##  - 4 embargoed or restricted (2.2 Mb)</span>
<span class="co">##  - 22 to download (43.6 Mb) </span>
<span class="co">## </span>
<span class="co">## 1: Yes</span>
<span class="co">## 2: No</span>
<span class="co">## </span>
<span class="co">## Selection:</span></pre></body></html></div>
<p>By default, the <code><a href="https://rdrr.io/pkg/safedata/man/download_safe_files.html">download_safe_files()</a></code> function downloads all of the files associated with the record. This will include <em>external</em> data files which may contain primary data that is not suited to the Excel format or additional information. Although many external files are likely to be readable in R, the<code>safedata</code> does not currently provide a mechanism to load them automatically. The function will also download the JSON metadata for the specified datasets.</p>
<p>The function will warn you if the local copies of data files have been altered and the <code>refresh=TRUE</code> argument can be used to restore data files to the version of record. Note that this will <strong>delete local changes</strong>.</p>
</div>
<div id="loading-data" class="section level1">
<h1 class="hasAnchor">
<a href="#loading-data" class="anchor"></a>Loading data</h1>
<p>The <code><a href="https://rdrr.io/pkg/safedata/man/load_safe_data.html">load_safe_data()</a></code> function is used to load a named data worksheet from a dataset into a <code>safedata</code> object. This is just a data frame with some additional attribute data and it will in general behave just like any other data frame - the additional attributes are used for further data processing and adding brief metadata to the <code>str</code> and <code>print</code> methods.</p>
<p>Some data formatting takes place based on <a href="https://safedata-validator.readthedocs.io/en/latest/data_format/data/#field-types">field types</a>: categorical variables are converted to factors; dates and datetimes are converted to <code>POSIXct</code> and times are converted to <code>chron::time</code> objects.</p>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="no">beetle_abund</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/safedata/man/load_safe_data.html">load_safe_data</a></span>(<span class="fl">1400562</span>, <span class="st">'Ant-Psel'</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">beetle_abund</span>)</pre></body></html></div>
<pre><code>## SAFE dataset
## Concept: 1400561; Record 1400562; Worksheet: Ant-Psel
## 'data.frame':    20 obs. of  3 variables:
##  $ Site                : chr  "SAFE_E" "SAFE_D" "SAFE_F" "SAFE_C" ...
##  $ ant species richness: num  31 31 27 29 31 21 31 25 32 26 ...
##  $ ant abundance       : num  561 713 392 481 1036 ...</code></pre>
<div class="sourceCode" id="cb30"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">beetle_abund</span>)</pre></body></html></div>
<pre><code>## SAFE dataset:
## Concept: 1400561; Record 1400562; Worksheet: Ant-Psel
## First 10 rows:
##        Site ant species richness ant abundance
## 1    SAFE_E                   31           561
## 2    SAFE_D                   31           713
## 3    SAFE_F                   27           392
## 4    SAFE_C                   29           481
## 5    SAFE_B                   31          1036
## 6    SAFE_A                   21           272
## 7  Maliau_1                   31          1889
## 8  Maliau_2                   25           409
## 9  Maliau_3                   32           613
## 10 Maliau_4                   26          1036</code></pre>
<p>The display of <code>safedata</code> objects is kept deliberately simple to avoid cluttering the screen with metadata. You can always view additional metadata for a loaded worksheet by using the <code>show</code> functions directly on the loaded <code>safedata</code> object:</p>
<div class="sourceCode" id="cb32"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/safedata/man/show_concepts.html">show_concepts</a></span>(<span class="no">beetle_abund</span>)</pre></body></html></div>
<pre><code>## 
## Concept ID: 1400561
## Title: Myrmecophilous Pselaphine beetles in tropical forests
## Versions: 1 available, 0 embargoed or restricted
## 
##  record_id  published embargo available
##    1400562 2018-08-20      --         *</code></pre>
<div class="sourceCode" id="cb34"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/safedata/man/show_concepts.html">show_record</a></span>(<span class="no">beetle_abund</span>)</pre></body></html></div>
<pre><code>## 
## Record summary
## Title: Myrmecophilous Pselaphine beetles in tropical forests
## Status: open
## Taxa: 67 taxa reported
## Locations: 20 locations reported
## 
## Data worksheets:
##             name ncol nrow description
## EnvironVariables    5   20 Environmental variables
##         Ant-Psel    4   20 Ant-Pselaphine data
##   MorphAbundance   44   20 Morphospeices abundance
## MorphFunctTraits   18   42 Morphospecies_Functional Traits</code></pre>
<div class="sourceCode" id="cb36"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/safedata/man/show_concepts.html">show_worksheet</a></span>(<span class="no">beetle_abund</span>)</pre></body></html></div>
<pre><code>## Record ID: 1400562
## Worksheet name: Ant-Psel
## Number of data rows: 20
## Number of data fields: 3
## Description:
## Ant-Pselaphine data
## Status: open
## 
## Fields:
##   field_name           field_type description                    
## 1 Site                 Location   Site where sample was collected
## 2 ant species richness Numeric    Number of ant species in sample
## 3 ant abundance        Abundance  Total number of ants in sample</code></pre>
<div id="dataset-taxa" class="section level2">
<h2 class="hasAnchor">
<a href="#dataset-taxa" class="anchor"></a>Dataset taxa</h2>
<p>There are a number of functions that can be used to work with the taxa in a dataset. Some generate simple tables of taxa:</p>
<ol style="list-style-type: decimal">
<li>
<p><code><a href="https://rdrr.io/pkg/safedata/man/get_taxa.html">get_taxa()</a></code>: This function loads a dataframe containing all of the taxa used within a dataset, with fields including the core GBIF taxonomic levels, the taxonomic label used within the dataset and the taxonomic status of the each taxon. You can load a taxonomic dataframe from a <code>safe_record_set</code> row or using an existing loaded <code>safedata</code> object.</p>
<div class="sourceCode" id="cb38"><html><body><pre class="r"><span class="no">beetle_taxa</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/safedata/man/get_taxa.html">get_taxa</a></span>(<span class="no">beetle_abund</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">beetle_taxa</span>)</pre></body></html></div>
<pre><code>## Classes 'safe_taxa' and 'data.frame':    43 obs. of  13 variables:
##  $ kingdom    : chr  "Animalia" "Animalia" "Animalia" "Animalia" ...
##  $ phylum     : chr  "Arthropoda" "Arthropoda" "Arthropoda" "Arthropoda" ...
##  $ class      : chr  "Insecta" "Insecta" "Insecta" "Insecta" ...
##  $ order      : chr  "Coleoptera" "Coleoptera" "Coleoptera" "Coleoptera" ...
##  $ family     : chr  "Pselaphidae" "Pselaphidae" "Staphylinidae" "Staphylinidae" ...
##  $ genus      : chr  NA NA "Mnia" "Aphilia" ...
##  $ species    : chr  NA NA NA NA ...
##  $ subspecies : chr  NA NA NA NA ...
##  $ variety    : chr  NA NA NA NA ...
##  $ form       : chr  NA NA NA NA ...
##  $ taxon_name : chr  "Psel1" "Psel10" "Psel11" "Psel12" ...
##  $ taxon_level: chr  "morphospecies" "morphospecies" "morphospecies" "morphospecies" ...
##  $ gbif_status: chr  "user" "user" "user" "user" ...</code></pre>
</li>
<li>
<p><code><a href="https://rdrr.io/pkg/safedata/man/add_taxa.html">add_taxa()</a></code>: This function adds taxonomic details to an already loaded data worksheet.</p>
<div class="sourceCode" id="cb40"><html><body><pre class="r"><span class="no">beetle_morph</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/safedata/man/load_safe_data.html">load_safe_data</a></span>(<span class="fl">1400562</span>, <span class="st">'MorphFunctTraits'</span>)
<span class="no">beetle_morph</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/safedata/man/add_taxa.html">add_taxa</a></span>(<span class="no">beetle_morph</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">beetle_morph</span>)</pre></body></html></div>
<pre><code>## SAFE dataset
## Concept: 1400561; Record 1400562; Worksheet: MorphFunctTraits
## 'data.frame':    42 obs. of  30 variables:
##  $ Morphospecies: chr  "Psel1" "Psel2" "Psel3" "Psel4" ...
##  $ AL           : num  0.663 0.702 0.702 1.599 1.131 ...
##  $ TAL          : num  0.117 0.039 0.39 0.234 0.234 0.273 0.078 0.351 0.117 0.156 ...
##  $ TAW          : num  0.117 0.039 0.195 0.117 0.234 0.234 0.078 0.234 0.078 0.078 ...
##  $ AN           : num  11 11 7 11 11 7 11 7 11 11 ...
##  $ HCA          : Factor w/ 2 levels "absent","present": 2 2 2 2 1 1 2 1 2 2 ...
##  $ HCP          : Factor w/ 2 levels "absent","present": 1 1 1 1 2 2 1 2 1 1 ...
##  $ TA           : Factor w/ 2 levels "absent","present": 2 2 2 2 1 1 2 2 2 2 ...
##  $ TP           : Factor w/ 2 levels "absent","present": 1 1 1 1 2 2 1 1 1 1 ...
##  $ FP           : Factor w/ 2 levels "absent","present": 1 2 2 2 2 2 2 2 2 2 ...
##  $ FA           : Factor w/ 2 levels "absent","present": 2 1 1 1 1 1 1 1 1 1 ...
##  $ Bef2         : Factor w/ 2 levels "absent","present": 2 1 1 1 2 1 2 1 2 2 ...
##  $ Bef3         : Factor w/ 2 levels "absent","present": 1 2 1 1 1 1 1 1 1 1 ...
##  $ Bef1         : Factor w/ 2 levels "absent","present": 1 1 2 2 1 2 1 2 1 1 ...
##  $ Bef0         : Factor w/ 2 levels "absent","present": 1 1 1 1 1 1 1 1 1 1 ...
##  $ Bef4         : Factor w/ 2 levels "absent","present": 1 1 1 1 1 1 1 1 1 1 ...
##  $ Myrmycophile : Factor w/ 4 levels "Facultative",..: NA 2 1 1 4 1 2 1 NA NA ...
##  $ kingdom      : chr  "Animalia" "Animalia" "Animalia" "Animalia" ...
##  $ phylum       : chr  "Arthropoda" "Arthropoda" "Arthropoda" "Arthropoda" ...
##  $ class        : chr  "Insecta" "Insecta" "Insecta" "Insecta" ...
##  $ order        : chr  "Coleoptera" "Coleoptera" "Coleoptera" "Coleoptera" ...
##  $ family       : chr  "Pselaphidae" "Staphylinidae" "Staphylinidae" "Staphylinidae" ...
##  $ genus        : chr  NA "Bibloporus" "Plagiophorus" "Harmophorus" ...
##  $ species      : chr  NA NA NA NA ...
##  $ subspecies   : chr  NA NA NA NA ...
##  $ variety      : chr  NA NA NA NA ...
##  $ form         : chr  NA NA NA NA ...
##  $ taxon_name   : chr  "Psel1" "Psel2" "Psel3" "Psel4" ...
##  $ taxon_level  : chr  "morphospecies" "morphospecies" "morphospecies" "morphospecies" ...
##  $ gbif_status  : chr  "user" "user" "user" "user" ...</code></pre>
</li>
<li>
<p>The <code>get_taxon_coverage</code> function can be used to get a taxon table of all taxa currently referenced in <em>all</em> datasets.</p>
<div class="sourceCode" id="cb42"><html><body><pre class="r"><span class="no">all_taxa</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/safedata/man/get_taxon_coverage.html">get_taxon_coverage</a></span>()
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">all_taxa</span>)</pre></body></html></div>
<pre><code>## Classes 'safe_taxa' and 'data.frame':   5811 obs. of  13 variables:
##  $ kingdom    : chr  "Plantae" "Plantae" "Animalia" "Plantae" ...
##  $ phylum     : chr  "Tracheophyta" "Tracheophyta" "Chordata" "Tracheophyta" ...
##  $ class      : chr  "Magnoliopsida" "Magnoliopsida" "Aves" "Magnoliopsida" ...
##  $ order      : chr  "Ericales" "Lamiales" "Columbiformes" "Ericales" ...
##  $ family     : chr  "Pentaphylacaceae" "Lamiaceae" "Columbidae" "Ebenaceae" ...
##  $ genus      : chr  NA "Congea" "Chalcophaps" "Diospyros" ...
##  $ species    : chr  NA NA NA "Diospyros frutescens" ...
##  $ subspecies : chr  NA NA NA NA ...
##  $ variety    : chr  NA NA NA NA ...
##  $ form       : chr  NA NA NA NA ...
##  $ taxon_name : chr  "Pentaphylacaceae" "Congea" "Chalcophaps" "Diospyros frutescens" ...
##  $ taxon_level: chr  "family" "genus" "genus" "species" ...
##  $ gbif_status: chr  "accepted" "accepted" "accepted" "accepted" ...</code></pre>
</li>
</ol>
<p>The other functions convert taxon tables into graphs (vertices and edges) and phylogenetic trees using the GBIF taxonomic backbone to represent phylogeny. The data validation should ensure that the taxa in a dataset can be connected as a phylogenetic tree, but this isn’t always the case. For this reason, these functions use a more general graph conversion and then checks whether the result can be converted to a phlyogenetic tree. Technically, that is checking that the graph is a connected, simple, directed acyclic graph.</p>
<ol style="list-style-type: decimal">
<li><p>The <code>get_taxon_graph</code> function converts a taxon table to a graph. The function also does some extra validation, and will give warnings when the taxon table has to be adjusted to represent the taxonomic hierarchy and worksheet taxa properly. The result is an object of class <code>igraph</code> and the vertices have attributes containing the original table data.</p></li>
<li><p>The <code>igraph_to_phylo</code> function tests whether a taxon graph can be converted to a phylogeny and returns a <code>phylo</code> object (package <code>ape</code>). The tips and internal nodes are labelled with taxon names but the <code>phylo</code> structure does not store other node information.</p></li>
<li>
<p><code><a href="https://rdrr.io/pkg/safedata/man/igraph_to_phylo.html">get_phylogeny()</a></code>: This is simply a wrapper that runs both functions above in turn to go straight to a phylogeny.</p>
<div class="sourceCode" id="cb44"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ape</span>)
<span class="no">beetle_phylo</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/safedata/man/igraph_to_phylo.html">get_phylogeny</a></span>(<span class="fl">1400562</span>)
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">beetle_phylo</span>, <span class="kw">show.node.label</span><span class="kw">=</span><span class="fl">TRUE</span>, <span class="kw">font</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">no.margin</span><span class="kw">=</span><span class="fl">TRUE</span>)</pre></body></html></div>
<p><img src="using_safe_data_files/figure-html/get_phylo-1.png" width="700"></p>
</li>
</ol>
</div>
<div id="dataset-locations" class="section level2">
<h2 class="hasAnchor">
<a href="#dataset-locations" class="anchor"></a>Dataset locations</h2>
<p>Nearly all SAFE datasets will include observations at spatial locations, and these datasets must include a Locations worksheet used as an spatial index for research activities. There are three functions that can be used to work with locations in a dataset. All of these functions use the <code>sf</code> package to represent the GIS geometry of locations and which provides an extensive toolset for further spatial analysis.</p>
<ol style="list-style-type: decimal">
<li>
<p><code><a href="https://rdrr.io/pkg/safedata/man/load_gazetteer.html">load_gazetteer()</a></code>: The gazetteer is one of the three key index files saved in the SAFE data directory and updated when <code><a href="https://rdrr.io/pkg/safedata/man/set_safe_dir.html">set_safe_dir()</a></code> is run. It includes sampling locations drawn from across a wide range of projects running at SAFE and is intended to hold all locations that are likely to see repeated sampling. Locations included the gazetteer can be used directly as <strong>known locations</strong> in datasets, although data providers can also include <strong>new locations</strong>.</p>
<div class="sourceCode" id="cb45"><html><body><pre class="r"><span class="no">gazetteer</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/safedata/man/load_gazetteer.html">load_gazetteer</a></span>()
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">gazetteer</span>)</pre></body></html></div>
<pre><code>## Simple feature collection with 5171 features and 15 fields
## geometry type:  GEOMETRY
## dimension:      XY
## bbox:           xmin: 116.9471 ymin: 4.41215 xmax: 117.9959 ymax: 4.961828
## CRS:            4326
## First 10 features:
##      location                type plot_size display_order parent region
## 1   SAFE_camp       SAFE basecamp      &lt;NA&gt;             3   &lt;NA&gt;   SAFE
## 2  Flux_tower          Flux tower      &lt;NA&gt;             7   &lt;NA&gt;   SAFE
## 3         A_1 SAFE Sampling point 25m x 25m             7   &lt;NA&gt;   SAFE
## 4         A_2 SAFE Sampling point 25m x 25m             7   &lt;NA&gt;   SAFE
## 5         A_3 SAFE Sampling point 25m x 25m             7   &lt;NA&gt;   SAFE
## 6         A_4 SAFE Sampling point 25m x 25m             7   &lt;NA&gt;   SAFE
## 7         A_5 SAFE Sampling point 25m x 25m             7   &lt;NA&gt;   SAFE
## 8         A_6 SAFE Sampling point 25m x 25m             7   &lt;NA&gt;   SAFE
## 9         A_7 SAFE Sampling point 25m x 25m             7   &lt;NA&gt;   SAFE
## 10        A_8 SAFE Sampling point 25m x 25m             7   &lt;NA&gt;   SAFE
##    fractal_order transect_order centroid_x centroid_y
## 1             NA             NA   117.6009   4.723797
## 2             NA             NA   117.6032   4.717283
## 3              1              1   117.6515   4.708505
## 4              1              1   117.6511   4.708578
## 5              1              1   117.6514   4.708950
## 6              1              2   117.6524   4.709513
## 7              1              2   117.6520   4.709589
## 8              1              2   117.6523   4.709968
## 9              1              3   117.6538   4.711672
## 10             1              3   117.6542   4.711600
##                                   source bbox_xmin bbox_ymin bbox_xmax
## 1                    Safe_camp_multi.shp  117.6001  4.723253  117.6016
## 2                               GPS data  117.6032  4.717283  117.6032
## 3  SAFE_core_sampling_stations_WGS84.shp  117.6515  4.708505  117.6515
## 4  SAFE_core_sampling_stations_WGS84.shp  117.6511  4.708578  117.6511
## 5  SAFE_core_sampling_stations_WGS84.shp  117.6514  4.708950  117.6514
## 6  SAFE_core_sampling_stations_WGS84.shp  117.6524  4.709513  117.6524
## 7  SAFE_core_sampling_stations_WGS84.shp  117.6520  4.709589  117.6520
## 8  SAFE_core_sampling_stations_WGS84.shp  117.6523  4.709968  117.6523
## 9  SAFE_core_sampling_stations_WGS84.shp  117.6538  4.711672  117.6538
## 10 SAFE_core_sampling_stations_WGS84.shp  117.6542  4.711600  117.6542
##    bbox_ymax                       geometry
## 1   4.724475 MULTIPOLYGON (((117.6007 4....
## 2   4.717283      POINT (117.6032 4.717283)
## 3   4.708505      POINT (117.6515 4.708505)
## 4   4.708578      POINT (117.6511 4.708578)
## 5   4.708950       POINT (117.6514 4.70895)
## 6   4.709513      POINT (117.6524 4.709513)
## 7   4.709589       POINT (117.652 4.709589)
## 8   4.709968      POINT (117.6523 4.709968)
## 9   4.711672      POINT (117.6538 4.711672)
## 10  4.711600        POINT (117.6542 4.7116)</code></pre>
</li>
<li>
<p><code><a href="https://rdrr.io/pkg/safedata/man/get_locations.html">get_locations()</a></code>: This function returns an <code>sf</code> object containing the locations used within a dataset. For known locations, the GIS data for the location are taken directly from the gazetteer. If the locations are new sampling sites, then GIS data provided in the dataset is used. Note that it is possible for dataset providers to create a new locations without including GIS data - these will be represented using empty GIS geometries.</p>
<p>By default, the returned <code>sf</code> object will only include the location name used in the dataset, the gazetteer name for known sampling sites and an indication of whether the location is new or known, but <code>gazetteer_info=TRUE</code> can be used to include the gazetteer attributes for known locations.</p>
<div class="sourceCode" id="cb47"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">sf</span>)</pre></body></html></div>
<pre><code>## Linking to GEOS 3.7.2, GDAL 2.4.2, PROJ 5.2.0</code></pre>
<div class="sourceCode" id="cb49"><html><body><pre class="r"><span class="no">beetle_locs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/safedata/man/get_locations.html">get_locations</a></span>(<span class="fl">1400562</span>)
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">beetle_locs</span>)</pre></body></html></div>
<pre><code>## Simple feature collection with 20 features and 3 fields
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: 116.967 ymin: 4.69223 xmax: 117.7981 ymax: 4.97022
## CRS:            4326
## First 10 features:
##          gazetteer_name new_location dataset_name                 geometry
## Maliau_1             NA         TRUE     Maliau_1 POINT (116.9707 4.74462)
## Maliau_2             NA         TRUE     Maliau_2 POINT (116.9748 4.74548)
## Maliau_3             NA         TRUE     Maliau_3 POINT (116.9675 4.74757)
## Maliau_4             NA         TRUE     Maliau_4 POINT (116.9714 4.74565)
## Maliau_5             NA         TRUE     Maliau_5 POINT (116.9781 4.74501)
## Maliau_6             NA         TRUE     Maliau_6 POINT (116.9669 4.75054)
## Maliau_7             NA         TRUE     Maliau_7 POINT (116.9731 4.74864)
## Maliau_8             NA         TRUE     Maliau_8 POINT (116.9701 4.74607)
## Danum_1              NA         TRUE      Danum_1  POINT (117.796 4.96444)
## Danum_2              NA         TRUE      Danum_2 POINT (117.7932 4.96486)</code></pre>
<div class="sourceCode" id="cb51"><html><body><pre class="r"><span class="no">fragments</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="no">gazetteer</span>, <span class="no">type</span><span class="kw">==</span><span class="st">'SAFE forest fragment'</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mar</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">1</span>,<span class="fl">1</span>))
<span class="fu"><a href="https://rdrr.io/pkg/sf/man/plot.html">plot</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/sf/man/st_geometry.html">st_geometry</a></span>(<span class="no">fragments</span>), <span class="kw">col</span><span class="kw">=</span><span class="st">'khaki'</span>, <span class="kw">graticule</span><span class="kw">=</span><span class="fl">TRUE</span>)
<span class="fu"><a href="https://rdrr.io/pkg/sf/man/plot.html">plot</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/sf/man/st_geometry.html">st_geometry</a></span>(<span class="no">beetle_locs</span>), <span class="kw">add</span><span class="kw">=</span><span class="fl">TRUE</span>, <span class="kw">col</span><span class="kw">=</span><span class="st">'red'</span>, <span class="kw">pch</span><span class="kw">=</span><span class="fl">4</span>)</pre></body></html></div>
<p><img src="using_safe_data_files/figure-html/get_locations-1.png" width="700"></p>
</li>
<li>
<p><code><a href="https://rdrr.io/pkg/safedata/man/add_locations.html">add_locations()</a></code>: This functions adds location data to an already loaded worksheet. The result is a <code>safedata</code> object that is also an <code>sf</code> object.</p>
<div class="sourceCode" id="cb52"><html><body><pre class="r"><span class="no">beetle_env</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/safedata/man/load_safe_data.html">load_safe_data</a></span>(<span class="fl">1400562</span>, <span class="st">'EnvironVariables'</span>)
<span class="no">beetle_env</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/safedata/man/add_locations.html">add_locations</a></span>(<span class="no">beetle_env</span>)
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">beetle_env</span>)</pre></body></html></div>
<pre><code>## SAFE dataset:
## Concept: 1400561; Record 1400562; Worksheet: EnvironVariables
## Simple feature collection with 20 features and 7 fields
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: 116.967 ymin: 4.69223 xmax: 117.7981 ymax: 4.97022
## CRS:            4326
## First 10 features:
##              Site     Temp Moisture Cover gazetteer_name new_location
## SAFE_E     SAFE_E 23.26667 40.73333    16             NA         TRUE
## SAFE_D     SAFE_D 23.76667 36.24000    32             NA         TRUE
## SAFE_F     SAFE_F 23.93333 26.71333    30             NA         TRUE
## SAFE_C     SAFE_C 22.80000 35.90667    15             NA         TRUE
## SAFE_B     SAFE_B 23.93333 20.96000    47             NA         TRUE
## SAFE_A     SAFE_A 23.73333 20.43333    23             NA         TRUE
## Maliau_1 Maliau_1 24.10000 18.08000   100             NA         TRUE
## Maliau_2 Maliau_2 24.00000 27.59000   100             NA         TRUE
## Maliau_3 Maliau_3 24.43333 14.46000   100             NA         TRUE
## Maliau_4 Maliau_4 25.00000 15.68667   100             NA         TRUE
##          dataset_name                 geometry
## SAFE_E         SAFE_E POINT (117.5785 4.69223)
## SAFE_D         SAFE_D POINT (117.5839 4.70618)
## SAFE_F         SAFE_F POINT (117.5355 4.69872)
## SAFE_C         SAFE_C POINT (117.6227 4.70994)
## SAFE_B         SAFE_B POINT (117.6145 4.72757)
## SAFE_A         SAFE_A  POINT (117.6472 4.7043)
## Maliau_1     Maliau_1 POINT (116.9707 4.74462)
## Maliau_2     Maliau_2 POINT (116.9748 4.74548)
## Maliau_3     Maliau_3 POINT (116.9675 4.74757)
## Maliau_4     Maliau_4 POINT (116.9714 4.74565)</code></pre>
<div class="sourceCode" id="cb54"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/sf/man/plot.html">plot</a></span>(<span class="no">beetle_env</span>[<span class="st">'Cover'</span>], <span class="kw">key.pos</span><span class="kw">=</span><span class="fl">4</span>, <span class="kw">breaks</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>,<span class="fl">100</span>, <span class="kw">by</span><span class="kw">=</span><span class="fl">5</span>))</pre></body></html></div>
<p><img src="using_safe_data_files/figure-html/add_locations-1.png" width="700"></p>
</li>
</ol>
</div>
</div>
<div id="inserting-datasets" class="section level1">
<h1 class="hasAnchor">
<a href="#inserting-datasets" class="anchor"></a>Inserting datasets</h1>
<p>If you want access to a dataset that is currently embargoed or restricted, then you can approach the authors listed on the Zenodo record to ask for permission to use the data. If you are then provided with the files for the dataset, then they need to be inserted into your local SAFE data directory so that they can be accessed by the <code>safedata</code> functions.</p>
<p>The <code>insert_dataset</code> function does this: it will check to see if a set of files are part of specified Zenodo record and then copy them into the correct places in the current SAFE data directory.</p>
<div class="sourceCode" id="cb55"><html><body><pre class="r"><span class="no">files</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">'safedata_example_dir'</span>, <span class="st">'template_ClareWfunctiondata.xlsx'</span>,
                     <span class="kw">package</span><span class="kw">=</span><span class="st">'safedata'</span>)
<span class="fu"><a href="https://rdrr.io/pkg/safedata/man/insert_dataset.html">insert_dataset</a></span>(<span class="fl">1237719</span>, <span class="no">files</span>)</pre></body></html></div>
<pre><code>## Inserting files: template_ClareWfunctiondata.xlsx</code></pre>
<pre><code>## NULL</code></pre>
<div class="sourceCode" id="cb58"><html><body><pre class="r"><span class="no">dat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/safedata/man/load_safe_data.html">load_safe_data</a></span>(<span class="fl">1237719</span>, <span class="st">'Data'</span>)</pre></body></html></div>
<pre><code>## Downloading 1 record metadata files</code></pre>
<div class="sourceCode" id="cb60"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">dat</span>)</pre></body></html></div>
<pre><code>## SAFE dataset
## Concept: 1198840; Record 1237719; Worksheet: Data
## 'data.frame':    34 obs. of  10 variables:
##  $ taxon_name              : chr  "Anguilla.borneensis" "Anguilla.marmorata" "Barbodes.sealei" "Barbonymus.balleroides" ...
##  $ Body_size               : num  24.14 30.56 8.51 11.36 7.59 ...
##  $ body_shape              : Factor w/ 3 levels "Compressed","Cylindrical",..: 2 2 1 1 1 2 1 2 1 2 ...
##  $ trophic_position        : Factor w/ 4 levels "Herbivore","Higher carnivore",..: 2 2 4 3 3 2 2 1 3 1 ...
##  $ mouth_position          : Factor w/ 3 levels "Inferior","Superior",..: 3 3 3 3 3 3 3 1 3 1 ...
##  $ presence_teeth          : Factor w/ 2 levels "no","yes": 2 2 1 1 2 2 1 1 1 1 ...
##  $ gregariousness          : Factor w/ 2 levels "no","yes": 1 1 2 2 1 1 1 2 2 2 ...
##  $ presence_barbels        : Factor w/ 2 levels "no","yes": 2 2 2 2 1 2 2 2 1 2 ...
##  $ vertical_position_water : Factor w/ 4 levels "Benthic","Benthopelagic",..: 2 2 3 3 2 2 2 2 3 1 ...
##  $ air-breathing_capability: Factor w/ 2 levels "no","yes": 2 2 1 1 2 2 1 1 1 1 ...</code></pre>
</div>
<div id="file-details-and-accessing-files" class="section level1">
<h1 class="hasAnchor">
<a href="#file-details-and-accessing-files" class="anchor"></a>File details and accessing files</h1>
<p>At the moment, the <code>safedata</code> package only handles loading data from the core Excel files. We do intend to add functions and recipes to access other files stored within a dataset in the future. At the moment, if you have downloaded all the files associated with a dataset then the <code>get_file_details</code> function allows you to quickly see a list of the files in a datset, whether you have downloaded a local copy and the absolute file path of those files.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Andy Aldersley, David Orme.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
